<?php

// $Id$

/**
 * @file
 *   Firm Updates functions
 */

/**
 * Get module to call views file
 */
function valeofirmupdates_views_api() {
	return array('api' => 2.0);
}



/**
 * Code for sending no-update alert emails to adminstrator
 */
function send_firm_update_alert() {
	// Add Postmark class
	require_once(dirname(dirname(__FILE__)) . '/valeomod/postmark/Postmark.php');
	$emaillist = array(
		'cchandler@valeopartners.com',
		'lgarrett@valeopartners.com',
		'tiffanyjohnson9@gmail.com',
		'victoriacpablo@gmail.com',
		'jillhoosier@hotmail.com',
		'denetram4@gmail.com',
		'natgip@hotmail.com',
		'cooper.trishia@gmail.com',
		'cehunter1@gmail.com'
	);
	$title = 'Valeo Firm Update Alert for '.date('n/j/Y');
	foreach ($emaillist AS $email) {
		$thisemail = trim($email);
		$message = valeo_update_alert_email(); // Only run the queries if this is a new user, not a different address for the same user.
		if ($message) {
			try {
				Mail_Postmark::compose()
					->to($thisemail)
					->from('alerts@valeopartners.com','Valeo Firm Update Alert')
					->subject($title)
					->messageHtml($message)
					->send();
			} catch (Exception $e) {
				watchdog('Update Alert Email', 'Failed sending firm update alert email to ' . $thisemail, NULL, WATCHDOG_NOTICE, NULL);
			}
		}
	}
}



/**
* Output Alert Email
*/
function valeo_update_alert_email() {
	try {
		$data = valeo_get_firm_update_content();
		$content = '<html><head><title>Firm Update Alert for '.date('n/j/Y').'</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><style type="text/css">body,.backgroundTable{background-color:#FFFFCC;}#contentTable{border:0px none #000000;margin-top:10px;}.adminText{font-size:10px;color:#663300;line-height:200%;font-family:Verdana;text-decoration:none;}.headerBar{background-color:#FFFFFF;border-top:0px none #333333;border-bottom:0px none #FFFFFF;padding:0px;}.headerBarText{color:#333333;font-size:30px;font-family:Verdana;font-weight:normal;text-align:left;}.title{font-size:16px;font-weight:bold;font-family:Verdana;line-height:150%;}.subTitle{font-size:14px;font-weight:bold;color:#000000;font-style:normal;font-family:Verdana;}.defaultText{font-size:12px;color:#333333;line-height:150%;font-family:Verdana;background-color:#ffffff;padding:20px;border:0px none #FFFFFF;}.footerRow{background-color:#8396BE;border-top:0px none #FFFFFF;padding:20px;}.footerText{font-size:10px;color:#333333;line-height:100%;font-family:Verdana;}a,a:link,a:visited{color:#800000;text-decoration:underline;font-weight:normal;}.headerTop a{color:#663300;text-decoration:none;font-weight:normal;}.footerRow a{color:#800000;text-decoration:underline;font-weight:normal;}body,.backgroundTable{background-color:#3B5998;}a,a:link,a:visited{text-decoration:none;color:#0066CC;}tr.even,tr.odd{background-color:#eeeeee;padding:0.1em 0.6em;}tr.even td,tr.odd td{border:1px solid #cccccc;padding:0.3em 0.6em;}tr.even{background-color:#ffffff;}th{text-align:left;padding:0.1em 0.6em;}</style></head>';
		$content .= '<body leftmargin="0" marginwidth="0" topmargin="0" marginheight="0" offset="0" style="background-color: #3B5998;"><table width="100%" cellspacing="0" class="backgroundTable" style="background-color: #3B5998;"><tr><td valign="top" align="center"><table id="contentTable" cellspacing="0" cellpadding="0" width="600" style="border: 0px none #000000;margin-top: 10px;background-color:#ffffff;"><tr><td><table width="600" cellpadding="0" cellspacing="0"><tr><td class="headerBar" style="background-color: #FFFFFF;border-top: 0px none #333333;border-bottom: 0px none #FFFFFF;padding: 10px;"><div class="headerBarText" style="color: #333333;font-size: 30px;font-family: Verdana;font-weight: normal;text-align: left;"><div style="text-align: left;"><a href="http://reports.valeopartners.com" style="color: #0066CC;text-decoration: none;font-weight: normal;"><img src="http://reports.valeopartners.com/email/valeo_hurricane_logo_small.gif" alt="Valeo Partners" border="0" style="margin: 0; padding: 0;" width="199" height="88"></a></div></div></td></tr></table>';
		$content .= '<table width="800" cellpadding="20" cellspacing="0" class="bodyTable" style="background-color:#ffffff;"><tr><td valign="top" align="left" class="defaultText"><h1 class="primary-heading"><span class="title" style="color:#000000;font-size:16px;font-weight:bold;font-family:Verdana;line-height:150%;">Firm Update Alert for '.date('n/j/Y').'</span></h1>';
		if (count($data)) {
			$content .= '<table cellspacing="0"><tbody>';
			$content .= '<tr>
				<td class="cell-firm" colspan="3"><span style="color:#000000;font-size:14px;font-weight:bold;line-height:200%;padding-top:20px;"><br>Firms Not Updated in Past 5 Days</span></td></tr>';
			$content .= '<tr class="alert-row-header">
							<th><em><span style="color:#000000;font-size:10px;font-weight:bold;">Firm</span></em></th>
							<th><em><span style="color:#000000;font-size:10px;font-weight:bold;">Last Updated</span></em></th>
							<th><em><span style="color:#000000;font-size:10px;font-weight:bold;">RA Assigned</span></em></th>
						</tr>';
			foreach ($data AS $thisFirm) {
				$content .= ($counter % 2 == 0) ? '<tr class="odd" style="background-color:#eeeeee;padding:0.1em 0.6em;">' : '<tr class="even" style="background-color:#ffffff;padding:0.1em 0.6em;">';
				$content .= '<td style="border:1px solid #cccccc;padding:0.3em 0.6em;" class="cell-firm"><span style="font-size:12px;padding:0.3em 0.6em;"><a href="http://reports.valeopartners.com/node/'.$thisFirm['nid'].'" title="See details for '.$thisFirm['node_title'].'" style="color: #0066CC;text-decoration: none;font-weight: normal;">'.$thisFirm['node_title'].'</a></span></td>';
				$content .= '<td style="border:1px solid #cccccc;padding:0.3em 0.6em;" class="cell-date"><span style="color:#000000;font-size:12px;padding:0.3em 0.6em;">'.date('n/j/Y g:ia',$thisFirm['vw_firm_updates_node_updated']).'</span></td>';
				$content .= '<td style="border:1px solid #cccccc;padding:0.3em 0.6em;" class="cell-ra"><span style="color:#000000;font-size:12px;padding:0.3em 0.6em;">'.$thisFirm['name'].'</span></td>';
				$content .= '</tr>';
				$counter++;
			}
			$content .= '</tbody></table>';
			$content .= '<br></td></tr></table></td></tr></table></td></tr></table></body></html>';
		} else {
			$content .= '';
		}
		return $content;
	} catch (Exception $e) {
		watchdog('Firm Update Alert Processing', 'Failed processing on ' . $data, NULL, WATCHDOG_NOTICE, NULL);
		return '';
	}
}



function valeo_get_firm_update_content($ID = false) {
	$query = "
			SELECT node.nid, 
				node.title AS node_title, 
				vw_firm_updates.node_updated AS vw_firm_updates_node_updated, 
				users.`name`
			FROM node node LEFT OUTER JOIN vw_firm_updates vw_firm_updates ON node.nid = vw_firm_updates.firm_nid
				LEFT OUTER JOIN content_type_firm node_data_field_firm_ra ON node.vid = node_data_field_firm_ra.vid
				LEFT OUTER JOIN users ON users.uid = node_data_field_firm_ra.field_firm_ra_uid
			WHERE (node.type IN('firm'))
				AND(node. STATUS = 1)
				AND(
					vw_firm_updates.node_updated < NOW() - 432000
				)
			ORDER BY node_title ASC";
	$result = db_query($query);
	while ($item = db_fetch_array($result))
		$thisdata[] = $item;
	return $thisdata;
}
