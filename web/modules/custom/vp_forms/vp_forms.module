<?php

/**
 * @file
 * Contains vp_forms.module.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_views_exposed_form_alter().
 */
function vp_forms_form_views_exposed_form_alter(array &$form, FormStateInterface $form_state, $form_id) {

  //kint($form['#id']);
  // Attach javascript library to all forms.
  $form['#attached']['library'][] = 'vp_forms/vp_forms_library';

  switch ($form['#id']) {

    case "views-exposed-form-search-rfp-pitch-analysis-rfp-pitch-analysis-page":

      // Remove the default "all" section if there's a request.
      // This prevents "illegal selection" from happening when there's no "all".
      $request = \Drupal::request();
      if (!is_null($request->get('field_vp_rate_firm_target_id_verf'))) {
        unset($form['field_vp_rate_firm_target_id_verf']['#options']['All']);
      }
      else {
        $form['field_vp_rate_firm_target_id_verf']['#options']['All'] = '- Select -';
      }
      break;

    case "views-exposed-form-search-rates-by-firm-detail-search-rates-by-firm-detail":
    case "views-exposed-form-search-fees-by-firm-search-fees-by-firm-page":

      // Change the form from a date picker to a dropdown.
      $form['field_vp_filing_fee_dates_value']['min']['#title'] = "Rate Year:<br>From date:";
      $form['field_vp_filing_fee_dates_value']['min']['#type'] = "select";
      $form['field_vp_filing_fee_dates_value']['min']['#multiple'] = FALSE;
      $form['field_vp_filing_fee_dates_value']['min']['#empty_option'] = '-All-';
      $form['field_vp_filing_fee_dates_value']['min']['#options'] = vp_api_year_options_min();
      unset($form['field_vp_filing_fee_dates_value']['min']['#size']);

      // Change the form from a date picker to a dropdown.
      $form['field_vp_filing_fee_dates_value']['max']['#title'] = "<br>To date:";
      $form['field_vp_filing_fee_dates_value']['max']['#type'] = "select";
      $form['field_vp_filing_fee_dates_value']['max']['#multiple'] = FALSE;
      $form['field_vp_filing_fee_dates_value']['max']['#empty_option'] = '-All-';
      $form['field_vp_filing_fee_dates_value']['max']['#options'] = vp_api_year_options_max();
      unset($form['field_vp_filing_fee_dates_value']['max']['#size']);

      // Change the form from textfield to a dropdown.
      $form['field_vp_graduation_value']['min']['#title'] = "Grad Date:<br>From date:";
      $form['field_vp_graduation_value']['min']['#type'] = "select";
      $form['field_vp_graduation_value']['min']['#multiple'] = FALSE;
      $form['field_vp_graduation_value']['min']['#empty_option'] = '-All-';
      $form['field_vp_graduation_value']['min']['#options'] = vp_api_bar_grad_year_options();
      unset($form['field_vp_graduation_value']['min']['#size']);

      // Change the form from textfield to a dropdown.
      $form['field_vp_graduation_value']['max']['#title'] = "<br>To date:";
      $form['field_vp_graduation_value']['max']['#type'] = "select";
      $form['field_vp_graduation_value']['max']['#multiple'] = FALSE;
      $form['field_vp_graduation_value']['max']['#empty_option'] = '-All-';
      // $form['field_vp_graduation_value']['max']['#default_value'] = '2010';
      $form['field_vp_graduation_value']['max']['#options'] = vp_api_bar_grad_year_options();
      unset($form['field_vp_graduation_value']['max']['#size']);

      // Change the form from textfield to a dropdown.
      $form['field_vp_bar_date_value']['min']['#title'] = "Bar Date:<br>From date:";
      $form['field_vp_bar_date_value']['min']['#type'] = "select";
      $form['field_vp_bar_date_value']['min']['#multiple'] = FALSE;
      $form['field_vp_bar_date_value']['min']['#empty_option'] = '-All-';
      $form['field_vp_bar_date_value']['min']['#options'] = vp_api_bar_grad_year_options();
      unset($form['field_vp_bar_date_value']['min']['#size']);

      // Change the form from textfield to a dropdown.
      $form['field_vp_bar_date_value']['max']['#title'] = "<br>To date:";
      $form['field_vp_bar_date_value']['max']['#type'] = "select";
      $form['field_vp_bar_date_value']['max']['#multiple'] = FALSE;
      $form['field_vp_bar_date_value']['max']['#empty_option'] = '-All-';
      $form['field_vp_bar_date_value']['max']['#options'] = vp_api_bar_grad_year_options();
      unset($form['field_vp_bar_date_value']['max']['#size']);

      break;

    case "views-exposed-form-search-rates-by-firm-summary-search-rates-by-firm-summary":

      // Change the form from textfield to a dropdown.
      $form['field_vp_graduation_value']['min']['#title'] = "Grad Date:<br>From date:";
      $form['field_vp_graduation_value']['min']['#type'] = "select";
      $form['field_vp_graduation_value']['min']['#multiple'] = FALSE;
      $form['field_vp_graduation_value']['min']['#empty_option'] = '-All-';
      $form['field_vp_graduation_value']['min']['#options'] = vp_api_bar_grad_year_options();
      unset($form['field_vp_graduation_value']['min']['#size']);

      // Change the form from textfield to a dropdown.
      $form['field_vp_graduation_value']['max']['#title'] = "<br>To date:";
      $form['field_vp_graduation_value']['max']['#type'] = "select";
      $form['field_vp_graduation_value']['max']['#multiple'] = FALSE;
      $form['field_vp_graduation_value']['max']['#empty_option'] = '-All-';
      $form['field_vp_graduation_value']['max']['#options'] = vp_api_bar_grad_year_options();
      unset($form['field_vp_graduation_value']['max']['#size']);

      // Change the form from textfield to a dropdown.
      $form['field_vp_bar_date_value']['min']['#title'] = "Bar Date:<br>From date:";
      $form['field_vp_bar_date_value']['min']['#type'] = "select";
      $form['field_vp_bar_date_value']['min']['#multiple'] = FALSE;
      $form['field_vp_bar_date_value']['min']['#empty_option'] = '-All-';
      $form['field_vp_bar_date_value']['min']['#options'] = vp_api_bar_grad_year_options();
      unset($form['field_vp_bar_date_value']['min']['#size']);

      // Change the form from textfield to a dropdown.
      $form['field_vp_bar_date_value']['max']['#title'] = "<br>To date:";
      $form['field_vp_bar_date_value']['max']['#type'] = "select";
      $form['field_vp_bar_date_value']['max']['#multiple'] = FALSE;
      $form['field_vp_bar_date_value']['max']['#empty_option'] = '-All-';
      $form['field_vp_bar_date_value']['max']['#options'] = vp_api_bar_grad_year_options();
      unset($form['field_vp_bar_date_value']['max']['#size']);

      break;

    case "views-exposed-form-search-ci-database-search-ci-database-page":
    case "views-exposed-form-search-fees-by-company-search-fees-by-company-page":
      // Change the form from a date picker to a dropdown.
      $form['field_vp_filing_fee_dates_value']['min']['#title'] = "Rate Year:<br>From date:";
      $form['field_vp_filing_fee_dates_value']['min']['#type'] = "select";
      $form['field_vp_filing_fee_dates_value']['min']['#multiple'] = FALSE;
      $form['field_vp_filing_fee_dates_value']['min']['#empty_option'] = '-All-';
      $form['field_vp_filing_fee_dates_value']['min']['#options'] = vp_api_year_options_min();
      unset($form['field_vp_filing_fee_dates_value']['min']['#size']);

      // Change the form from a date picker to a dropdown.
      $form['field_vp_filing_fee_dates_value']['max']['#title'] = "<br>To date:";
      $form['field_vp_filing_fee_dates_value']['max']['#type'] = "select";
      $form['field_vp_filing_fee_dates_value']['max']['#multiple'] = FALSE;
      $form['field_vp_filing_fee_dates_value']['max']['#empty_option'] = '-All-';
      $form['field_vp_filing_fee_dates_value']['max']['#options'] = vp_api_year_options_max();
      unset($form['field_vp_filing_fee_dates_value']['max']['#size']);

      break;

  }

}

/**
 * Implements hook_form_alter().
 */
function vp_forms_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  /* @var Drupal\Core\Entity\FieldableEntityInterface $entity */
  $formObject = $form_state->getFormObject();
  if ($formObject instanceof \Drupal\Core\Entity\EntityFormInterface) {
    $entity = $formObject->getEntity();
    if (
      $entity->getEntityTypeId() === 'node'
      && in_array($entity->bundle(), ['vp_type_saved_search'])
    ) {
      $form['#attached']['library'][] = 'vp_forms/vp_forms_library';
    }
  }
}
